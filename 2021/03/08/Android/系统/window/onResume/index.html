<!DOCTYPE html><html data-theme="light"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>onResume | Fan Blog</title><meta name="description" content="​"><meta name="keywords" content="Android"><meta name="author" content="Fan shanhong"><meta name="copyright" content="Fan shanhong"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="onResume"><meta name="twitter:description" content="​"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="onResume"><meta property="og:url" content="http://yoursite.com/2021/03/08/Android/系统/window/onResume/"><meta property="og:site_name" content="Fan Blog"><meta property="og:description" content="​"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2021/03/08/Android/系统/window/onResume/"><link rel="prev" title="setContentView2" href="http://yoursite.com/2021/03/08/Android/系统/window/setContent2/"><link rel="next" title="19.1.ByteBuf2" href="http://yoursite.com/2021/03/03/Netty/19.1.ByteBuf2/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Fan Blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">158</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">31</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">26</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#handleResumeActivity"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">handleResumeActivity</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#WindowManagerImpl-addView"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">WindowManagerImpl.addView</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#构造：root-new-ViewRootImpl-view-getContext-display"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">构造：root = new ViewRootImpl(view.getContext(), display);</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#IWindowSession"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">IWindowSession</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#root-setView-view-wparams-panelParentView"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">root.setView(view, wparams, panelParentView);</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#结束"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">结束</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#handleResumeActivity"><span class="toc-number">1.</span> <span class="toc-text">handleResumeActivity</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WindowManagerImpl-addView"><span class="toc-number">2.</span> <span class="toc-text">WindowManagerImpl.addView</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#构造：root-new-ViewRootImpl-view-getContext-display"><span class="toc-number">3.</span> <span class="toc-text">构造：root = new ViewRootImpl(view.getContext(), display);</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IWindowSession"><span class="toc-number">3.1.</span> <span class="toc-text">IWindowSession</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#root-setView-view-wparams-panelParentView"><span class="toc-number">4.</span> <span class="toc-text">root.setView(view, wparams, panelParentView);</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#结束"><span class="toc-number">5.</span> <span class="toc-text">结束</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">onResume</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2021-03-08<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2021-04-04</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><!-- TOC -->
<ul>
<li><a href="#handleresumeactivity">handleResumeActivity</a></li>
<li><a href="#windowmanagerimpladdview">WindowManagerImpl.addView</a></li>
<li><a href="#构造root--new-viewrootimplviewgetcontext-display">构造：root = new ViewRootImpl(view.getContext(), display);</a><ul>
<li><a href="#iwindowsession">IWindowSession</a></li>
</ul>
</li>
<li><a href="#rootsetviewview-wparams-panelparentview"><code>root.setView(view, wparams, panelParentView);</code></a></li>
<li><a href="#结束">结束</a></li>
</ul>
<!-- /TOC -->
<h1 id="handleResumeActivity"><a href="#handleResumeActivity" class="headerlink" title="handleResumeActivity"></a>handleResumeActivity</h1><p>在 AcitityThread.handleLauncherActivity() 中执行完performLaunchAcitity()创建好Acitivity并完成onCreate()方法的调用后，继续执行handleResumeActivity()方法。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[ActivityThread.java]</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">        ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">		...</span><br><span class="line">        <span class="comment">//该方法执行过程中会调用到Acitity的onResume()方法，</span></span><br><span class="line">        <span class="comment">//返回的ActivityClientRecord对象对应的已经创建好并且初始化好的Activity</span></span><br><span class="line">        r = performResumeActivity(token, clearHide, reason);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> Activity a = r.activity;<span class="comment">//得到前面创建好的Activity</span></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">           		判断该Acitivity是否可见</span></span><br><span class="line"><span class="comment">                mStartedAcitity记录的是一个Activity是否还处于启动状态</span></span><br><span class="line"><span class="comment">　　　　　　	  如果还处于启动状态则mStartedAcitity为true，表示该activity还未启动好，则该Activity还不可见</span></span><br><span class="line"><span class="comment">				注意mStartedActivity的值在performLaunchActivity中会被设为false，代表已经启动好了</span></span><br><span class="line"><span class="comment">			*/</span></span><br><span class="line">            <span class="keyword">boolean</span> willBeVisible = !a.mStartedActivity;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">				此处再次向AMS查询，目标Activity是否应该可见</span></span><br><span class="line"><span class="comment">			*/</span></span><br><span class="line">            <span class="keyword">if</span> (!willBeVisible) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    willBeVisible = ActivityManagerNative.getDefault().willActivityBeVisible(</span><br><span class="line">                            a.getActivityToken());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">					获取前面为目标Activity创建好的::</span></span><br><span class="line"><span class="comment">					窗口Window</span></span><br><span class="line"><span class="comment">					窗口管理器</span></span><br><span class="line"><span class="comment">					DecorView</span></span><br><span class="line"><span class="comment">					</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line">                r.window = r.activity.getWindow(); <span class="comment">// 拿到  Activity  的 mWindow，即 PhoneWindow</span></span><br><span class="line">                View decor = r.window.getDecorView(); <span class="comment">// 拿到PhoneWindow 的 DecorView</span></span><br><span class="line">                decor.setVisibility(View.INVISIBLE); <span class="comment">// 设置 DecorView 不可见</span></span><br><span class="line">                ViewManager wm = a.getWindowManager(); <span class="comment">// 拿到Activity的 WindowManagerImpl 对象</span></span><br><span class="line">                WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">                a.mDecor = decor; <span class="comment">// 把 PhoneWindow的 decor 赋给 Activity的 Decor。注意啊，在这之前，DecorView一直都是PhoneWindow的成员变量，没有与Activity关联，现在把它赋给了Activity的成员</span></span><br><span class="line">                l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">                l.softInputMode |= forwardBit;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//调用了WindowManagerImpl的addView方法</span></span><br><span class="line">                <span class="keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</span><br><span class="line">                    a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                    wm.addView(decor, l);<span class="comment">//这个是重点</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!willBeVisible) &#123;</span><br><span class="line">				...</span><br><span class="line">            &#125;</span><br><span class="line">			...</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible</span><br><span class="line">                    &amp;&amp; r.activity.mDecor != <span class="keyword">null</span> &amp;&amp; !r.hideForNow) &#123;</span><br><span class="line">				...</span><br><span class="line">				<span class="comment">//设置目标Activity可见</span></span><br><span class="line">                <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                    r.activity.makeVisible();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//此处是通知AMS目标Activity已经执行完onResume完毕了</span></span><br><span class="line">            <span class="keyword">if</span> (reallyResume) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ActivityManagerNative.getDefault().activityResumed(token);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>
<p>流程：</p>
<ol>
<li><p>执行目标Activity的onResume()方法</p>
</li>
<li><p>如果Activity 可见，赋值一堆东西</p>
</li>
<li><p>接着调用WindowManagerImpl实例对象的addView()方法对Activity对应的DecorView做进一步的处理</p>
</li>
<li><p>最后将目标Activiyt设置为可见</p>
</li>
</ol>
<h1 id="WindowManagerImpl-addView"><a href="#WindowManagerImpl-addView" class="headerlink" title="WindowManagerImpl.addView"></a>WindowManagerImpl.addView</h1><p>看下 WindowManagerImpl实例对象的addView()方法，参数view 是 Activity 中的 Window 对应的 DecorView 对象<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WindowManagerImpl</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">        applyDefaultToken(params);</span><br><span class="line">        <span class="comment">// 注意此时的mParentWindow指向了前面创建的Activity对应的窗口PhoneWindow</span></span><br><span class="line">        mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>使用 WindowManagerGlobal 的 addView 方法。先看下 WindowManagerGlobal 的成员变量</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[WindowManagerGlobal.java]</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> WindowManagerGlobal sDefaultWindowManager; <span class="comment">// 单例模式，WindowManagerGlobal 自己</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IWindowManager sWindowManagerService;  <span class="comment">// 这个也是  WMS 的远端代理</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IWindowSession sWindowSession;<span class="comment">// WMS服务提供给ViewRootImpl,用来和其进行跨Binder通信的接口 ，即 WMS 的远端代理</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object mLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="keyword">new</span> ArrayList&lt;ViewRootImpl&gt;();  <span class="comment">// ViewRootImpl 是  WindowManagerGlobal中真正做事的</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;WindowManager.LayoutParams&gt; mParams =</span><br><span class="line">            <span class="keyword">new</span> ArrayList&lt;WindowManager.LayoutParams&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArraySet&lt;View&gt; mDyingViews = <span class="keyword">new</span> ArraySet&lt;View&gt;();</span><br></pre></td></tr></table></figure></div>
<p>下面看 WindowManagerGlobal 的 addView 方法<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, //此处的view指向DecorView</span></span></span><br><span class="line"><span class="function"><span class="params">    					ViewGroup.LayoutParams params,//这里的params为Window对应的默认WindowManager.LayoutParams实例对象mWindowAttributes</span></span></span><br><span class="line"><span class="function"><span class="params">            			Display display, //这里的Display具体指向表示物理显示设备有关的逻辑显示的大小(譬如尺寸分辨率)</span>和密度的信息</span></span><br><span class="line"><span class="function">            			Window parentWindow) <span class="comment">//这里的parentWindow指向了Activity对应的窗口实例对象PhoneWindow</span></span></span><br><span class="line"><span class="function">                         </span>&#123;</span><br><span class="line">        <span class="comment">// 拿到传入的布局参数</span></span><br><span class="line">        <span class="keyword">final</span> WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</span><br><span class="line">       ...</span><br><span class="line">        ViewRootImpl root;</span><br><span class="line">        View panelParentView = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 查找是否已经有该 View</span></span><br><span class="line">            <span class="keyword">int</span> index = findViewLocked(view, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 构建ViewRootImpl,它是WindowManagerGlobal最最得力的干将没有之一,基本包揽了WindowManagerGlobal绝大部分工作</span></span><br><span class="line">            root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line"></span><br><span class="line">            view.setLayoutParams(wparams);</span><br><span class="line"></span><br><span class="line">            mViews.add(view);</span><br><span class="line">            mRoots.add(root);</span><br><span class="line">            mParams.add(wparams);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// do this last because it fires off messages to start doing things</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 将DecorView添加到ViewRootImpl中,最后添加到WMS中。这里应该是真正去调用WMS了吧？</span></span><br><span class="line">            root.setView(view, wparams, panelParentView);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>先构建一个 ViewRootImpl，然后通过 ViewRootImpl  的  setView 方法，完成窗口视图的添加和显示过程。<br>Activiyt的显示更多的就是和WMS的交互来完成的。</p>
<p>分析至此我们知道，当应用程序向窗口管理器（WindowManagerImpl）中添加一个窗口视图对象（addView）时，首先会为该视图对象创建一个ViewRootImpl对象，并且将视图对象（View）、ViewRootImpl对象、视图布局参数（ViewGroup.LayoutParams）分别保存到窗口管理器WindowManagerGlobal的mViews、mRoots、mParams数组中(并且他们三者在对应的数组中的索引是一一对应的)，如下图所示：<br><a href="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/DecorView_ViewRootImpl_LayoutParams.png" data-fancybox="group" data-caption class="fancybox"><img src="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/DecorView_ViewRootImpl_LayoutParams.png" alt title></a></p>
<p>下面我们看  ViewRootImpl 是如果构造的，以及如何 setView的。</p>
<h1 id="构造：root-new-ViewRootImpl-view-getContext-display"><a href="#构造：root-new-ViewRootImpl-view-getContext-display" class="headerlink" title="构造：root = new ViewRootImpl(view.getContext(), display);"></a>构造：root = new ViewRootImpl(view.getContext(), display);</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[ViewRootImpl.java]</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> IWindowSession mWindowSession;</span><br><span class="line">    <span class="comment">// 这个 ViewRootHandler 就是个普通的Handler</span></span><br><span class="line">    <span class="comment">// final class ViewRootHandler extends Handler&#123;&#125;</span></span><br><span class="line">	<span class="keyword">final</span> ViewRootHandler mHandler = <span class="keyword">new</span> ViewRootHandler(); </span><br><span class="line">	<span class="comment">// These can be accessed by any thread, must be protected with a lock.</span></span><br><span class="line">    <span class="comment">// Surface can never be reassigned or cleared (use Surface.clear()).</span></span><br><span class="line">    <span class="keyword">final</span> Surface mSurface = <span class="keyword">new</span> Surface();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">			得到IWindowSession的远端代理对象</span></span><br><span class="line"><span class="comment">            该对象是WMS端暴露给窗口端的，用于和WMS服务端通信的Binder通道</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">        mWindowSession = WindowManagerGlobal.getWindowSession();</span><br><span class="line">        ...</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">			创建了一个W本地Binder对象，用于WMS通知应用程序进程</span></span><br><span class="line"><span class="comment">			有点像ActiviytThread中的IApplicationThread实例对象</span></span><br><span class="line"><span class="comment">            后续应该会把这个 W 作为匿名Binder 发到 WMS，然后WMS拿到W就可以和客户端交互了？</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			关于Activity和WMS的交互完全可以参考Activity启动过程中和AMS的交互</span></span><br><span class="line"><span class="comment">			但是ActivityThread中的IApplicationThread是单一实例，而这里的W却是每一个</span></span><br><span class="line"><span class="comment">			ViewRootImpl都拥有一个			</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">        mWindow = <span class="keyword">new</span> W(<span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">			构造一个AttachInfo对象</span></span><br><span class="line"><span class="comment">			注意类型为Handler的参数，传入的是：ViewRootHandler实例mHandler，</span></span><br><span class="line"><span class="comment">			这个Handler用于处理Android应用程序的窗口信息</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">        mAttachInfo = <span class="keyword">new</span> View.AttachInfo(mWindowSession, mWindow, display, <span class="keyword">this</span>, mHandler, <span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>
<p>ViewRootImpl 构造总结：创建ViewRootHandler，创建Surface，获取IWindowSession的代理对象，创建IWindow实体 mWindow，创建View.AttachInfo</p>
<p><a href="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/ViewRootImpl_WMS_releationship.png" data-fancybox="group" data-caption class="fancybox"><img src="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/ViewRootImpl_WMS_releationship.png" alt title></a></p>
<h2 id="IWindowSession"><a href="#IWindowSession" class="headerlink" title="IWindowSession"></a>IWindowSession</h2><p>getWindowSession()获取和WMS通信的Binder代理端IWindowSession</p>
<p>IWindowSession是一个AIDL类<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[IWindowSession.aidl]</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	中文翻译一下就是用于每个应用程序和WMS进行通信的接口</span></span><br><span class="line"><span class="comment"> * System private per-application interface to the window manager.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IWindowSession</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p><a href="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/IWindowSession.png" data-fancybox="group" data-caption class="fancybox"><img src="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/IWindowSession.png" alt title></a></p>
<p>看下源码<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[WindowManagerGlobal.java]</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWindowSession <span class="title">getWindowSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sWindowSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">//获取输入法管理器服务Binder代理端</span></span><br><span class="line">                    InputMethodManager imm = InputMethodManager.getInstance();</span><br><span class="line">					<span class="comment">//获取窗口管理器服务Binder代理端</span></span><br><span class="line">                    IWindowManager windowManager = getWindowManagerService();</span><br><span class="line">					<span class="comment">//得到IWindowSession代理对象</span></span><br><span class="line">					<span class="comment">//这里需要注意的是传递的两个参数都是匿名Binder，所以匿名Binder读者最好能掌握掌握</span></span><br><span class="line">                    sWindowSession = windowManager.openSession(</span><br><span class="line">                            <span class="keyword">new</span> IWindowSessionCallback.Stub() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimatorScaleChanged</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</span><br><span class="line">                                    ValueAnimator.setDurationScale(scale);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            imm.getClient(), imm.getInputContext());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sWindowSession;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></p>
<p><a href="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/IWindowManager.png" data-fancybox="group" data-caption class="fancybox"><img src="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/IWindowManager.png" alt title></a></p>
<p>拿到 IWindowManager  的 代理端：IWindowManager.Stub.Proxy，然后调用 Proxy的 openSession方法。通过Binder驱动，最终调用到WindowManagerService的openSession()方法中。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[windowManagerService.java]</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IWindowSession <span class="title">openSession</span><span class="params">(IWindowSessionCallback callback, IInputMethodClient client,</span></span></span><br><span class="line"><span class="function"><span class="params">            IInputContext inputContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//异常检测</span></span><br><span class="line">        <span class="keyword">if</span> (client == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null client"</span>);</span><br><span class="line">        <span class="keyword">if</span> (inputContext == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null inputContext"</span>);</span><br><span class="line">        <span class="comment">//直接明了，构建一个Session实例。这个 this  是  WMS 自己，后续Session实体再收到请求，就直接转发给 WMS了。</span></span><br><span class="line">        Session session = <span class="keyword">new</span> Session(<span class="keyword">this</span>, callback, client, inputContext);</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>
<p>在WindowManagerService的openSession()方法中，直接创建了一个 Session 对象，Session 是什么<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Session</span> <span class="keyword">extends</span> <span class="title">IWindowSession</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">IBinder</span>.<span class="title">DeathRecipient</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>可以看到对象，Session是 IWindowSession.Stub  的 服务实体。把Session 直接返回，然后就通过Binder驱动把Session返回到 APP进程端，APP端在 WindowManagerGlobal.getWindowSession 中拿到的就是 IWindowSession代理对象了，即：IWindowSession.Stub.Proxy 。并且保存在 WindowManagerGlobal的 静态变量 sWindowSession 中。</p>
<p>现在，WindowManagerGlobal 就持有了两个变量了</p>
<ol>
<li>sWindowManagerService 是 WMS 的远端代理： IWindowManager.Stub.Proxy</li>
<li>sWindowSession，也是一个远端代理，IWindowSession.Stub.Proxy</li>
</ol>
<p>要这么多干嘛？</p>
<p>IWindow<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[IWindow.aidl]</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	这里我用我蹩脚的英文简单翻译一下就是，WMS服务用于通知客户端窗口一些事情的通道</span></span><br><span class="line"><span class="comment"> * API back to a client window that the Window Manager uses to inform it of</span></span><br><span class="line"><span class="comment"> * interesting things happening.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">oneway <span class="class"><span class="keyword">interface</span> <span class="title">IWindow</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>此处的W本地对象用于WMS通知应用程序进程，有点像ActiviytThread中的IApplicationThread实例对象用于AMS和APP进程通信的方法，都是使用匿名Binder！</p>
<p>即：WMS 端会持有一个 IWindow的 远端代理对象，然后APP端持有IWindow的服务实体， 这样WMS通过 IWindow的远端代理同APP进程进行通信。</p>
<p><a href="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/IWindow.png" data-fancybox="group" data-caption class="fancybox"><img src="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/IWindow.png" alt title></a></p>
<p>现在，APP进程通过WindowManagerService的远端代理 sWindowManagerService 同AMS通信， AMS通过IWindow 的远端代理通客户端通信。那 IWindowSession.Stub.Proxy 还需要么。</p>
<p>ViewRootImpl 构造好了，下面看它如何 setView</p>
<h1 id="root-setView-view-wparams-panelParentView"><a href="#root-setView-view-wparams-panelParentView" class="headerlink" title="root.setView(view, wparams, panelParentView);"></a><code>root.setView(view, wparams, panelParentView);</code></h1><p><a href="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/addView.png" data-fancybox="group" data-caption class="fancybox"><img src="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/addView.png" alt title></a></p>
<p>注意第一阶段，是在 handleResumeActivity，当Activity  onResume 之后，使用 Activity 的 WindowManagerImpl 的 addView方法。</p>
<p>WindowManagerImpl.add(decorView)</p>
<p>这里，Activity 的 WindowManagerImpl 和 PhoneWindow 的 WindowManagerImpl 是相同的。<br>Activity的 DecorView 和  PhoneWindow 的 DecorView 也是相同的。</p>
<p>也可以理解为：使用PhoneWindow的 WindowManagerImpl 把它（PhoneWindow）的DecorView 加入到 Window管理器中。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 这里我们分析的是Activity的DecorView窗口视图添加的逻辑，所以此时不存在父视图的概念，</span></span><br><span class="line"><span class="comment">   	 不会走到这里，此时的panelParentView为null</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">              ..</span><br><span class="line">              </span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">               	这里调用异步刷新请求，最终会调用performTraversals方法来完成View的绘制</span></span><br><span class="line"><span class="comment">               	在向WMS添加窗口前进行UI布局</span></span><br><span class="line"><span class="comment">              */</span></span><br><span class="line">              requestLayout();</span><br><span class="line">		</span><br><span class="line">              <span class="keyword">if</span> ((mWindowAttributes.inputFeatures</span><br><span class="line">                      &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>) &#123;</span><br><span class="line">                  mInputChannel = <span class="keyword">new</span> InputChannel();</span><br><span class="line">              &#125;</span><br><span class="line">		...</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">			...</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">				将窗口添加到WMS服务中，mWindow为W本地Binder对象，</span></span><br><span class="line"><span class="comment">				通过Binder传输到WMS服务端后，变为IWindow代理对象</span></span><br><span class="line"><span class="comment">			*/</span></span><br><span class="line">                  res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                          getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">                          mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                          mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">              &#125;</span><br><span class="line">  			...</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>
<p>就做了两件事情，</p>
<ol>
<li>调用ViewRootImpl内部方法requestLayout，对窗口视图中的UI进行窗口布局等操作(测量，布局，绘图)，</li>
<li>然后调用前面的获取的代理端IWindowSession的addToDisplay向WMS添加一个窗口对象。这里把 应用进程的 W本地 Binder 服务实体传入了。在WMS端接收到之后，就能通过W的远端代理和应用进程通信了。</li>
</ol>
<p>伪代码：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WindowManagerImpl.addView(...)---&gt;</span><br><span class="line">WindowManagerGlobal.addView(...)---&gt;</span><br><span class="line">	parentWindow.adjustLayoutParamsForSubWindow(...)---&gt;</span><br><span class="line">	<span class="keyword">new</span> ViewRootImpl(...)---&gt;</span><br><span class="line">		WindowManagerGlobal.getWindowSession()---&gt;</span><br><span class="line">		<span class="keyword">new</span> W(<span class="keyword">this</span>)---&gt;</span><br><span class="line">		Choreographer.getInstance()---&gt;</span><br><span class="line">	mViews.add(view)---&gt;</span><br><span class="line">    mRoots.add(root)---&gt;</span><br><span class="line">    mParams.add(wparams)---&gt;</span><br><span class="line">	ViewRootImpl.setView(...)---&gt;</span><br><span class="line">		mWindowSession.addToDisplay(...)---&gt;</span><br></pre></td></tr></table></figure></div></p>
<p>IWindowSession调用addToDisplay，进入 WMS 端<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[Sesstion.java'</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addToDisplay</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId, Rect outContentInsets, Rect outStableInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">            Rect outOutsets, InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//注意这里的mService是在前面WMS调用openSession方法构造Session时传递过来的引用</span></span><br><span class="line">        <span class="keyword">return</span> mService.addWindow(<span class="keyword">this</span>, window, seq, attrs, viewVisibility, displayId,</span><br><span class="line">                outContentInsets, outStableInsets, outOutsets, outInputChannel);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>其实Session就是一个中间人而已，APP应用程序段通过它的跨进程Binder能力发送来的请求，它想都不想直接传给WMS服务进行处理了。那这个Session有何用。</p>
<p>下面WMS开始真正开始窗口添加。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[WindowManagerService.java]</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * All currently active sessions with clients.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;Session&gt; mSessions = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mapping from an IWindow IBinder to the server's Window object.</span></span><br><span class="line"><span class="comment">     * This is also used as the lock for all of our state.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">NOTE:</span> Never call into methods that lock ActivityManagerService while holding this object.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> HashMap&lt;IBinder, WindowState&gt; mWindowMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mapping from a token IBinder to a WindowToken object.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> HashMap&lt;IBinder, WindowToken&gt; mTokenMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">            WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">            Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</span></span></span><br><span class="line"><span class="function"><span class="params">            InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//这里的client为IWindow的代理对象，用于WMS和Activity进行通信</span></span><br><span class="line">        ...</span><br><span class="line">        WindowState attachedWindow = <span class="keyword">null</span>;</span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">			<span class="comment">//判断我们添加的窗口是否已经存在</span></span><br><span class="line">            <span class="keyword">if</span> (mWindowMap.containsKey(client.asBinder())) &#123;</span><br><span class="line">                Slog.w(TAG_WM, <span class="string">"Window "</span> + client + <span class="string">" is already added"</span>);</span><br><span class="line">                <span class="keyword">return</span> WindowManagerGlobal.ADD_DUPLICATE_ADD; <span class="comment">// 返回重复添加</span></span><br><span class="line">            &#125;</span><br><span class="line">            ..</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> addToken = <span class="keyword">false</span>;</span><br><span class="line">			<span class="comment">//根据attrs.token从mTokenMap中取出应用程序窗口在WMS服务中的描述符WindowToken</span></span><br><span class="line">            WindowToken token = mTokenMap.get(attrs.token);</span><br><span class="line">            AppWindowToken atoken = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">boolean</span> addToastWindowRequiresToken = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">           ...</span><br><span class="line">			<span class="comment">//(注意这里只是因为分析的是Activity窗口的添加而已)创建WindowState对象</span></span><br><span class="line">            WindowState win = <span class="keyword">new</span> WindowState(<span class="keyword">this</span>, session, client, token,</span><br><span class="line">                    attachedWindow, appOp[<span class="number">0</span>], seq, attrs, viewVisibility, displayContent);</span><br><span class="line"> </span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">			<span class="comment">//以键值对&lt;IWindow.Proxy/Token,WindowToken&gt;形式保存到mTokenMap表中</span></span><br><span class="line">			<span class="comment">//在Activity的窗口添加过程中，不会走到此处，因为在Activity启动中在创建的时候已经有添加了，这个在Token传递的篇章里面已经有分析过了</span></span><br><span class="line">            <span class="keyword">if</span> (addToken) &#123;</span><br><span class="line">                mTokenMap.put(attrs.token, token);</span><br><span class="line">            &#125;</span><br><span class="line">            win.attach();</span><br><span class="line">			<span class="comment">//以键值对&lt;IWindow的代理对象,WindowState&gt;形式保存到mWindowMap表中</span></span><br><span class="line">            mWindowMap.put(client.asBinder(), win);</span><br><span class="line">			</span><br><span class="line">			...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> imMayMove = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type == TYPE_INPUT_METHOD) &#123;</span><br><span class="line">				...</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TYPE_INPUT_METHOD_DIALOG) &#123;</span><br><span class="line">				...</span><br><span class="line">                addWindowToListInOrderLocked(win, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                addWindowToListInOrderLocked(win, <span class="keyword">true</span>);<span class="comment">//将WindowState添加到关联的AppWindowToken中</span></span><br><span class="line">				...</span><br><span class="line">            &#125;</span><br><span class="line">		...</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>
<p>从我们前面的分析可知知道当应用程序进程添加一个DecorView到窗口管理器时，会为当前添加的窗口创建ViewRootImpl对象，同时构造了一个W本地Binder对象，无论是窗口视图对象DecorView还是ViewRootImpl对象，都只是存在于应用程序进程中，在添加窗口过程中仅仅将该窗口的W对象传递给WMS服务，经过Binder传输后，到达WMS服务端进程后变为IWindow.Proxy代理对象，因此该函数的参数client的类型为IWindow.Proxy，这个就是我们client参数的终极由来</p>
<ol>
<li>根据attrs.token从mTokenMap取出应用程序窗口在WMS服务中的描述符WindowToken。attrs.token 是key。</li>
<li>构建一个 WindowState</li>
<li>将 WindowState 以键值对&lt;IWindow的代理对象,WindowState&gt;形式保存到mWindowMap表中</li>
</ol>
<p><a href="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/tokenmap.png" data-fancybox="group" data-caption class="fancybox"><img src="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/tokenmap.png" alt title></a></p>
<p>后续调用：addWindowToListInOrderLocked(win, true);//将WindowState添加到关联的AppWindowToken中</p>
<p><a href="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/apptoke.png" data-fancybox="group" data-caption class="fancybox"><img src="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/apptoke.png" alt title></a></p>
<h1 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h1><ul>
<li>应用程序端的每个窗口对应的ViewRootImpl对持有一个W对象，而WMS端持有它的代理端用于和APP的信息回调</li>
<li>然后每个应用程序进程都持有一个与WMS服务会话通道IWindowSession，系统中创建的所有IWindowSession都被记录到WMS服务的mSessions成员变量中，这样WMS就可以知道自己正在处理那些应用程序的请求。</li>
<li>然后为每个窗口在WMS端创建一个WindowState对象，该对象是应用程序窗口在WMS服务端的描述符，有点类似于Activity在AMS端的描述符ActivityRecord</li>
</ul>
<p>现在只是把 WindowState 注册到WMS 了。但是并没有送到 SurfaceFlinger去绘制。</p>
<p>如何送到 SurfaceFlinger的呢？</p>
<p><a href="https://blog.csdn.net/windskier/article/details/7041610" target="_blank" rel="noopener">https://blog.csdn.net/windskier/article/details/7041610</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Fan shanhong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2021/03/08/Android/系统/window/onResume/">http://yoursite.com/2021/03/08/Android/系统/window/onResume/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2021/03/08/Android/系统/window/setContent2/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>setContentView2</span></div></a></div><div class="next-post pull_right"><a href="/2021/03/03/Netty/19.1.ByteBuf2/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>19.1.ByteBuf2</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2018/10/08/Android/系统/启动/冷启动/" title="冷启动热启动"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-08</div><div class="relatedPosts_title">冷启动热启动</div></div></a></div><div class="relatedPosts_item"><a href="/2018/10/06/Android/其他/APK安装和卸载源码分析/" title="APK安装和卸载源码分析"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-06</div><div class="relatedPosts_title">APK安装和卸载源码分析</div></div></a></div><div class="relatedPosts_item"><a href="/2018/11/08/Android/其他/SharedPreference分析/" title="SharedPreference分析"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-11-08</div><div class="relatedPosts_title">SharedPreference分析</div></div></a></div><div class="relatedPosts_item"><a href="/2018/10/08/Android/其他/getExternalCacheDir目录下的东东, 在APK卸载的时候是否会被删除/" title="getExternalCacheDir目录下的东东, 在APK卸载的时候是否会被删除"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-08</div><div class="relatedPosts_title">getExternalCacheDir目录下的东东, 在APK卸载的时候是否会被删除</div></div></a></div><div class="relatedPosts_item"><a href="/2018/10/02/Android/其他/查看处理器架构命令/" title="查看处理器架构命令"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-02</div><div class="relatedPosts_title">查看处理器架构命令</div></div></a></div><div class="relatedPosts_item"><a href="/2018/12/08/Android/其他/versionName和versionCode/" title="versionName和versionCode"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-12-08</div><div class="relatedPosts_title">versionName和versionCode</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Fan shanhong</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async></script></body></html>