<!DOCTYPE html><html data-theme="light"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Activity启动 | Fan Blog</title><meta name="description" content="​"><meta name="keywords" content="Android"><meta name="author" content="Fan shanhong"><meta name="copyright" content="Fan shanhong"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Activity启动"><meta name="twitter:description" content="​"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="Activity启动"><meta property="og:url" content="http://yoursite.com/2021/03/08/Android/系统/Activity启动/"><meta property="og:site_name" content="Fan Blog"><meta property="og:description" content="​"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2021/03/08/Android/系统/Activity启动/"><link rel="prev" title="Binder系统核心" href="http://yoursite.com/2021/03/14/Android/系统/binder/1.Binder系统核心/"><link rel="next" title="Window的创建" href="http://yoursite.com/2021/03/08/Android/系统/window/window的创建/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Fan Blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">158</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">31</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">26</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Activity启动的整体概括"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">Activity启动的整体概括</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#流程"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">流程</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Activity启动的整体概括"><span class="toc-number">1.</span> <span class="toc-text">Activity启动的整体概括</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#流程"><span class="toc-number">2.</span> <span class="toc-text">流程</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">Activity启动</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2021-03-08<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2021-04-02</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><!-- TOC -->
<ul>
<li><a href="#activity启动的整体概括">Activity启动的整体概括</a></li>
<li><a href="#流程">流程</a></li>
</ul>
<!-- /TOC -->
<h1 id="Activity启动的整体概括"><a href="#Activity启动的整体概括" class="headerlink" title="Activity启动的整体概括"></a>Activity启动的整体概括</h1><p>  在正式开始Activity漫长而又复杂的启动流程分析之前，让我们先来高屋建瓴的整体概括一下Activity的启动流程(以冷启动为例),其大致可以划分为如下阶段：</p>
<p> Souruce端进程发送请求目标Activity启动阶段：</p>
<ol>
<li><p>Source端发起显示/隐式启动请求启动Activity</p>
<p>system_server进程通过AMS处理启动Activity请求：</p>
</li>
<li><p>解析启动目标Activity的Intent</p>
</li>
<li>创建目标Activity对应的ActivityRecord</li>
<li>为目标Activity查找/分配或者创建最优Task栈</li>
<li>Pause前台Activity</li>
<li>Resume请求的目标Activity</li>
<li><p>AMS请求zygote进程为目标Activity创建所属进程</p>
<p>zygote进程处理system_server进程发送的创建目标Activity进程请求阶段：</p>
</li>
<li><p>zygote接受AMS请求fork创建目标Activity所属进程</p>
</li>
<li>调用RuntimeInit，初始化目标进程运行环境</li>
<li><p>通过反射调用目标进程ActivityThread主线程main方法，开启目标进程新时代</p>
<p>目标Activity进程启动阶段：<br> 11. 开启目标Activity进程的的Looper消息循环<br> 12. 注册ApplicationThread到system_server进程<br> 13. 创建目标进程Application，并执行其onCreate方法</p>
<p>开启目标Activity生命周期阶段：</p>
</li>
<li><p>真正启动目的端Activity</p>
</li>
<li>通过反射加载目标Activity</li>
<li>执行目标Activity生命周期</li>
<li><p>初始化目标Activity窗口为显示做准备</p>
<p>目标Activity显示阶段：</p>
</li>
<li><p>新建DecorView</p>
</li>
<li>新建ViewRootImpl</li>
<li><p>将window添加到WMS准备显示</p>
<p>Source端Activity收尾工作：</p>
</li>
<li><p>Source端Activity执行onStop()等逻辑</p>
</li>
</ol>
<p>通常我们启动Activity有两个方法startActivity和startActivityForResult。这里我们可以看到Activity中调用startActivity的内部也是调用的startActivityForResult的。<br>  而我们知道通过startActivityForResult启动目标Activity可以在Activity中回调onActivityResult接收目标Acitiy启动的情况，而调用startActivity则不可以呢？其最最主要的原因就是调用startActivity启动目标Acitivity时，其内部调用startActivityForResult传递的参数requestCode被默认赋予为-1了在后续过程中会根据此值判断是否需要传递回调用结果，这也意味着我们在Activity调用startActivityForResult的时候传递的requestCode值为-1(通过后续分析我们可知，只要小于0)的话，那么onActivityResult是不起作用的。所以当我们调用startActivityForResult的时候需要注意这一点。</p>
<h1 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startActivity()</span><br></pre></td></tr></table></figure></div>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startActivityForResult()</span><br></pre></td></tr></table></figure></div>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mInstrumentation.execStartActivity(</span><br><span class="line">                    <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                    intent, requestCode, options)</span><br></pre></td></tr></table></figure></div>
<blockquote>
<pre><code>Instrumentation是android系统中启动Activity的一个实际操作类
</code></pre></blockquote>
<blockquote>
<pre><code>说的Source端开始请求执行启动Activity实际上就是Instrumentation进行实际操作执行的 这里有一个知识点我想强调一下的就是对于每一个
</code></pre></blockquote>
<blockquote>
<pre><code>Android App进程来说，它的总入口都是ActivityThread的main方法，每一个应用的进程都有且仅有一个ActivityThread对象，而每一个ActivityThread对象有且仅有一个Instrumentation成员变量，即整个App进程中ActivityThread和Instrumentation实例对象是唯一的。
</code></pre></blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Instrumentation.java</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Context who, </span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder contextThread, </span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder token, </span></span></span><br><span class="line"><span class="function"><span class="params">            Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> requestCode, </span></span></span><br><span class="line"><span class="function"><span class="params">            Bundle options)</span></span></span><br></pre></td></tr></table></figure></div>
<ul>
<li>contextThread<br>参数类型为IBinder实例，该对象继承于ApplicationThreadNative(Binder服务端)，这个ApplicationThread对象很重要，因为正是通过它串联其了AMS对发起端进程的ActivityThread的交互(如果把ApplicationThread当作服务端，那么此时AMS 就是客户端)</li>
</ul>
<p>其两者之间的关系建立详见下述的示意图，即AMS持有ApplicationThread的代理端，而应用端进程持有AMS的代理端AMP，二者相互持有各自Binder服务端的代理端进而完成了二者之间的RPC调用。在目标Activiy启动后，发起端Activity的onPause的执行是由ApplicationThread的代理端在AMS中通过Binder IPC透传过来，然后发起端Activity执行onPause流程</p>
<p><a href="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/application_thread_binder.png" data-fancybox="group" data-caption class="fancybox"><img src="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/application_thread_binder.png" alt title></a></p>
<ul>
<li><p>token<br>参数类型也为IBinder实例，指向发起端（Source端）Activity的ActivityRecord对象中的Token（其实就是 Binder的代理端），其Binder实体在AMS中。是个 window manager token</p>
</li>
<li><p>target<br>参数类型为Activity实例，标明发起端Activity，如果发起端不为Activity此时为null</p>
</li>
<li><p>intent<br>参数类型为Intent实例，用来表明要启动的Activity信息，此时的intent可能是显示Intent，也可能是隐式Intent，我们此处的是一个隐式Intent。显式intent通常用在包内启动组件，如果是启动其他APP的组件，则通常用隐式intent。显式intent里面包含了一个ComponentName，ComponentName由包名 + 类名组成，可以唯一标识一个组件，系统通过ComponentName就可以找到要启动的组件。隐式intent通常通过Action来过滤出要启动的组件</p>
</li>
<li><p>requestCode<br>参数类型为int，启动Activity的请求码，此请求码表明发起端是否需要接收目标Activity启动的结果</p>
</li>
<li><p>options<br>参数类型为Bundle ，可以理解我启动目标Activity的附件参数，譬如附件传输的一些额外信息</p>
</li>
</ul>
<p>内部调用：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ActivityManagerNative.getDefault()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                        requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br></pre></td></tr></table></figure></div></p>
<p>ActivityManagerNative.getDefault() 最后构造一个  new ActivityManagerProxy(new BinderProxy(new BpBinder(handle)))</p>
<p>实际是调用  ActivityManagerProxy 的  startActivity  方法，通过Binder底层，最后进入ActivityManagerNative  的 onTransact()方法，然后进入 ActivityManagerService  的  startActivity() 方法</p>
<p><a href="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/ActivityManagerProxy.startactivity.png" data-fancybox="group" data-caption class="fancybox"><img src="https://cdn.jsdelivr.net/gh/fanshanhong/note-image/ActivityManagerProxy.startactivity.png" alt title></a></p>
<p>关于上述整个Binder IPC调用流程，可以使用如下伪代码来简述</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AMP.startActivity(...)---&gt; </span><br><span class="line">BinderProxy.transact(...) ---&gt;</span><br><span class="line">BpBinder.transact(...)---&gt;</span><br><span class="line">binder驱动传输---&gt;</span><br><span class="line">JavaBBinder.onTransact(...)---&gt;</span><br><span class="line">AMN.onTransact(..)---&gt;</span><br><span class="line">AMN.startActivity(...)</span><br></pre></td></tr></table></figure></div>
<p>我们先看一下 ActivityManagerProxy 的 startActivity</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityManagerNative.java</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, </span></span></span><br><span class="line"><span class="function"><span class="params">    						 String callingPackage, </span></span></span><br><span class="line"><span class="function"><span class="params">    						 Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">            				 String resolvedType, </span></span></span><br><span class="line"><span class="function"><span class="params">            				 IBinder resultTo, </span></span></span><br><span class="line"><span class="function"><span class="params">            				 String resultWho, </span></span></span><br><span class="line"><span class="function"><span class="params">            				 <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> startFlags, </span></span></span><br><span class="line"><span class="function"><span class="params">                             ProfilerInfo profilerInfo, </span></span></span><br><span class="line"><span class="function"><span class="params">                             Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        Parcel reply = Parcel.obtain();</span><br><span class="line">        <span class="comment">//写入AMS Binder服务描述信息即android.app.IActivityManager</span></span><br><span class="line">        data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">        <span class="comment">//写入 IApplicationThread 匿名Binder服务实体(这个在attachApplication时写入过)</span></span><br><span class="line">        data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">        ...</span><br><span class="line">        data.writeStrongBinder(resultTo);</span><br><span class="line">        ...</span><br><span class="line">		<span class="comment">//mRemote指向BinderProxy，而BinderProxy持有C++端的BpBinder，进而借助Binder驱动和AMS通信,最后调用到ActivityManagerNative的onTransact()方法中</span></span><br><span class="line">        mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        reply.readException();</span><br><span class="line">        <span class="keyword">int</span> result = reply.readInt();</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></div>
<p>注意第一个参数 caller。是在 startActivityForResult  方法中一路传下来的。<br>最开始传入的是：mMainThread.getApplicationThread()，丢入mInstrumentation.execStartActivity()，然后放入 ActivityManagerProxy.startActivity(…)</p>
<p>Activity 中的  mMainThread  是：ActivityThread<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Activity.java中</span></span><br><span class="line">ActivityThread mMainThread;</span><br></pre></td></tr></table></figure></div></p>
<p>ActivityThread 中<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread.java</span></span><br><span class="line"> <span class="keyword">final</span> ApplicationThread mAppThread = <span class="keyword">new</span> ApplicationThread();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApplicationThread <span class="title">getApplicationThread</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mAppThread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationThread</span> <span class="keyword">extends</span> <span class="title">ApplicationThreadNative</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>因此，拿到的是发起端进程的 ApplicationThread  的实体</p>
<p>data.writeStrongBinder 的时候写入了 ApplicationThread.asBinder()<br>ApplicationThread  的 asBinder()方法</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ApplicationThreadNative.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>因此，写入 Parcel的是 发起端进程 ApplicationThreadNative 实体。</p>
<p>好了，下面Binder驱动跳过，直接进入ActivityManagerNative.onTransact()的  case START_ACTIVITY_TRANSACTION:<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityManagerNative.java</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> START_ACTIVITY_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">            IBinder b = data.readStrongBinder();</span><br><span class="line">			<span class="comment">//转换成ApplicationThread Binder实体代理端ApplicationThreadProxy</span></span><br><span class="line">            IApplicationThread app = ApplicationThreadNative.asInterface(b);</span><br><span class="line">            String callingPackage = data.readString();</span><br><span class="line">            Intent intent = Intent.CREATOR.createFromParcel(data);</span><br><span class="line">            String resolvedType = data.readString();</span><br><span class="line">            IBinder resultTo = data.readStrongBinder();</span><br><span class="line">            ...</span><br><span class="line">			<span class="comment">//调用AMN的子类ActivityManagerService</span></span><br><span class="line">            <span class="keyword">int</span> result = startActivity(app, callingPackage, intent, resolvedType,</span><br><span class="line">                    resultTo, resultWho, requestCode, startFlags, profilerInfo, options);</span><br><span class="line">            reply.writeNoException();</span><br><span class="line">            reply.writeInt(result);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></div></p>
<blockquote>
<p>在正式开始上述的源码分析前，我们先来阐述一个重要的知识点,即在这个调用过程中涉及到两个进程，不妨令startActivity的发起进程记为进程Process_A，AMS Service所属进程记为进程Process_B；那么进程Process_A通过Binder机制（采用IActivityManager接口）向进程Process_B发起请求服务，进程Process_B则通过Binder机制(采用IApplicationThread接口)向进程Process_A发起请求服务。也就是说进程Process_A与进程Process_B能相互间主动发起请求，进而完成进程通信，但是这里有一点需要注意IApplicationThread的Binder实体端并没有注册到servicemanager进程中，它是一个依赖于实名Binder的匿名Binder。</p>
</blockquote>
<p>调用AMN的子类ActivityManagerService处理 startActivity。<br>最终由 ActivityStarter来处理 startActivity。<code>mActivityStarter.startActivityMayWait</code></p>
<p>ActivityStarter.startActivityMayWait<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityStarter.java</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProfilerInfo profilerInfo, IActivityManager.WaitResult outResult, Configuration config,</span></span></span><br><span class="line"><span class="function"><span class="params">            Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">            IActivityContainer iContainer, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">        <span class="keyword">final</span> Intent ephemeralIntent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line">        <span class="comment">//以传递进来的intent为参数重新创建新的Intent对象，即便intent被修改也不受影响</span></span><br><span class="line">        intent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line">        <span class="comment">//收集Intent所指向的Activity信息, 当存在多个可供选择的Activity,则直接向用户弹出resolveActivity </span></span><br><span class="line">        ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);<span class="comment">//重点分析该方法</span></span><br><span class="line">        <span class="keyword">if</span> (rInfo == <span class="keyword">null</span>) &#123;<span class="comment">//不会进入该分支</span></span><br><span class="line">        	...</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//根据获取的rInfo信息重新组装intent和设置启动的参数信息</span></span><br><span class="line">        ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ActivityStack stack;</span><br><span class="line">        <span class="keyword">if</span> (container == <span class="keyword">null</span> || container.mStack.isOnHomeDisplay()) &#123;<span class="comment">//传入的参数container为null</span></span><br><span class="line">            stack = mSupervisor.mFocusedStack;<span class="comment">//进入该分支</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            stack = container.mStack;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">         <span class="keyword">final</span> ActivityRecord[] outRecord = <span class="keyword">new</span> ActivityRecord[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">		<span class="comment">//继续跟进</span></span><br><span class="line">         <span class="keyword">int</span> res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                 aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line">                 resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                 callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                 options, ignoreTargetSecurity, componentSpecified, outRecord, container,</span><br><span class="line">                 inTask);</span><br><span class="line"></span><br><span class="line">         Binder.restoreCallingIdentity(origId);</span><br><span class="line">		...</span><br><span class="line">		<span class="keyword">return</span> res;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>初步处理启动Activiyt的请求,</p>
<p>借助 ActivityStackSupervisor的 resolveIntent方法，收集Activity信息。<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);</span><br></pre></td></tr></table></figure></div></p>
<p>该方法内部主要通过 PackageManagerService来来解析Intent。在应用没起来之前，只有PMS知道应用都有哪些组件，所以AMS必须借助PKMS来完成相关intent的查询。应用四大组件的信息在应用安装的时候，就已经被PMS解析保存起来了。如果没有声明在AndroidManifest.xml文件中，那么AMS就无法获取目标组件的信息，对于显式intent，会抛出错误；对于隐式intent，也会启动失败。</p>
<p>解析Intent，就是从系统中查找符合要求的目标Activity。找到后，封装在ResolveInfo里。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据获取的rInfo信息重新组装intent和设置启动的参数信息</span></span><br><span class="line">        ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br></pre></td></tr></table></figure></div>
<p>根据前面获取的rInfo信息重新组装intent和设置Activity启动的参数信息。</p>
<p>然后调用ActivityStarter的startActivityLocked方法</p>
<p>在这里做了：</p>
<ol start="0">
<li>做各种异常检查，权限检查</li>
<li>创建要启动的 Activity 的 ActivityRecord对象</li>
<li>ActivityStarter.startActivityUnchecked</li>
</ol>
<p>至此目标Ativity相关信息已经在AMS中建立了</p>
<p>小结：</p>
<ul>
<li>发起端进程是怎么通过Instrumentation管理类，并且借助AMP完成启动Activity请求的发送</li>
<li>system_server进程中的AMS初步处理启动Activiyt的请求，并借助PKMS服务解析intent获取目标Activity的ActivityInfo信息，然后通过上述解析得到的数据为目标Activiyt构建ActivityRecord数据结构</li>
</ul>
<p>ActivityStarter.startActivityUnchecked主要工作：为目标Activity查找/分配或者创建最优Task栈<br>1、初始化Activity启动状态<br>2、计算launchFlag<br>3、计算调用者的ActivityStack<br>4、检查是否存在复用的TaskRecord<br>5、对于存在复用的TaskRecord则进行相应的ActivityStack、TaskRecord的移动（说实话，我也没有真的搞懂，希望这块比较有经验的小伙们能和我一起学习）<br>6、计算当前启动Activity所属的TaskRecord<br>7、把当前启动的Activity放到所属TaskRecord的栈顶</p>
<p>8、最后调用resumeFocusedStackTopActivityLocked创建正在启动的Activity、Paused当前resumed的Activity，<br>9、以及resumed当前启动的Activity</p>
<p>从8开始，</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">                mSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>进入 ActivityStackSupervisor 的 resumeFocusedStackTopActivityLocked方法<br>最终进入：ActivityStack.resumeTopActivityUncheckedLocked<br>继续： ActivityStack.resumeTopActivityInnerLocked<br>先 做一些初始化和可能的”异常”处理工作。 比如 A(Launcher) 启动 B(APP)</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[ActivityStack.java]</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这个 prev 传入的就是要启动的Activity 的 ActivityRecord对象</span></span><br><span class="line">		...</span><br><span class="line">        <span class="comment">/*  比如 A 启动 B</span></span><br><span class="line"><span class="comment">	        找到第一个没有finishing的栈顶activity,通常指向了要启动的Activity目标组件</span></span><br><span class="line"><span class="comment">	        此场景下prev和next都是同一个，都指向了Activity B</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">final</span> ActivityRecord next = topRunningActivityLocked();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拿到 目标Activity 的 TaskRecord</span></span><br><span class="line">        <span class="keyword">final</span> TaskRecord prevTask = prev != <span class="keyword">null</span> ? prev.task : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;<span class="comment">//这个表示如果当前ActivityStack不存在待启动的Activity，那么会启动Launcher桌面</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        next.delayedResume = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查要启动的Activity 组件是否等于当前被激活的 Activity 组件，如果等于</span></span><br><span class="line">        <span class="comment">//并且处于 RESUMED 状态，直接返回，我们前面演示的启动情况很显然不满足条件</span></span><br><span class="line">        <span class="keyword">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</span><br><span class="line">                    mStackSupervisor.allResumedActivitiesComplete()) &#123;</span><br><span class="line">             <span class="comment">//当前正在显示的Activity正好就是下一个待显示的Activity，</span></span><br><span class="line">            <span class="comment">// 那么，就中断对目标ActivityRecord的调度</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> TaskRecord nextTask = next.task;</span><br><span class="line">         <span class="comment">/*这个是对上一个resumed的Activity的相关处理</span></span><br><span class="line"><span class="comment">		 * 由于我们是第一次启动B Activity，所以不可能处于finish跳过此处</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">        <span class="keyword">if</span> (prevTask != <span class="keyword">null</span> &amp;&amp; prevTask.stack == <span class="keyword">this</span> &amp;&amp;</span><br><span class="line">                prevTask.isOverHomeStack() &amp;&amp; prev.finishing &amp;&amp; prev.frontOfTask) &#123;</span><br><span class="line">			...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 系统进入休眠状态，当前Stack的栈顶Activity已经处于Paused状态</span></span><br><span class="line">        <span class="comment">// 那么，中断待显示Activity的相关调度(有点拗口，学习源码就是这么枯燥的事情)</span></span><br><span class="line">        <span class="keyword">if</span> (mService.isSleepingOrShuttingDownLocked()</span><br><span class="line">                &amp;&amp; mLastPausedActivity == next</span><br><span class="line">                &amp;&amp; mStackSupervisor.allPausedActivitiesComplete()) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">			在ASS中存在很多的数据结构，用来统一管理ActivityRecord的状态</span></span><br><span class="line"><span class="comment">	    	譬如mStoppingActivities记录了当前所有处于Stopping状态的ActivityRecord</span></span><br><span class="line"><span class="comment">	    	mGoingToSleepActivities记录了当前所有要进入休眠状态的ActivityRecord</span></span><br><span class="line"><span class="comment">	    	在某些场景下，待显示的ActivityRecord可能处于这些数组中，但需要从中剔除</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">        mStackSupervisor.mStoppingActivities.remove(next);</span><br><span class="line">        mStackSupervisor.mGoingToSleepActivities.remove(next);</span><br><span class="line">        next.sleeping = <span class="keyword">false</span>;</span><br><span class="line">        mStackSupervisor.mWaitingVisibleActivities.remove(next);</span><br><span class="line"></span><br><span class="line">             <span class="comment">// 如果当前ASS中还有ActivityRecord不是处于PAUSED, STOPPED或STOPPING这三个状态之一，</span></span><br><span class="line">    	<span class="comment">// 那么，需要先等这些ActivityRecord进入停止状态</span></span><br><span class="line">        <span class="keyword">if</span> (!mStackSupervisor.allPausedActivitiesComplete()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></div>
<p>前面的代码片段，主要是做一些初始化和可能的”异常”处理工作。</p>
<p>比如 A(Launcher) 启动 B(APP)</p>
<p>然后开始 Pause  前台 Activity(A  Launcher) ：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//此时要带入真是场景了，此时的mResumedActivity表示目标Stack栈中处于Resume状态的Activity，那么在此场景下就是Activity A，这个因该比较容易理解</span></span><br><span class="line"><span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">	<span class="comment">//当前resumd状态activity不为空，则需要先暂停该Activity</span></span><br><span class="line">	<span class="comment">// pause当前栈的activity，即执行Activity的生命周期onPause</span></span><br><span class="line">          pausing |= startPausingLocked(userLeaving, <span class="keyword">false</span>, <span class="keyword">true</span>, dontWaitForPause);</span><br><span class="line">	</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (pausing) &#123;<span class="comment">//当前有正在pause的Activity，尼玛按照我们场景Activity A启动Activity B，那不是到此就结束了啊，直接返回了</span></span><br><span class="line">          <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">              mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>Pause 前台Activity 的 核心方法： ActivityStack.startPausingLocked</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[ActivityStack.java]</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, </span></span></span><br><span class="line"><span class="function"><span class="params">    								<span class="keyword">boolean</span> uiSleeping, //此时传递进来的参数为<span class="keyword">false</span></span></span></span><br><span class="line"><span class="function"><span class="params">    								<span class="keyword">boolean</span> resuming,//此时传递进来的参数为<span class="keyword">true</span></span></span></span><br><span class="line"><span class="function"><span class="params">            						<span class="keyword">boolean</span> dontWait)</span> </span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//获取当前Stack栈中处于Resume状态的Activity，在我们当前的环境下就是Activity A了</span></span><br><span class="line">        ActivityRecord prev = mResumedActivity;</span><br><span class="line">        <span class="keyword">if</span> (prev == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!resuming) &#123;</span><br><span class="line">                mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">// 变更ActivityStack中pauseActivity的记录，此处是重点</span></span><br><span class="line">        mResumedActivity = <span class="keyword">null</span>;</span><br><span class="line">        mPausingActivity = prev;</span><br><span class="line">        mLastPausedActivity = prev;</span><br><span class="line">        mLastNoHistoryActivity = (prev.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_HISTORY) != <span class="number">0</span></span><br><span class="line">                || (prev.info.flags &amp; ActivityInfo.FLAG_NO_HISTORY) != <span class="number">0</span> ? prev : <span class="keyword">null</span>;</span><br><span class="line">        prev.state = ActivityState.PAUSING;</span><br><span class="line">        prev.task.touchActiveTime();</span><br><span class="line">        clearLaunchTime(prev);</span><br><span class="line">        </span><br><span class="line">		...</span><br><span class="line">		 <span class="comment">// 通知APP执行发起端的pause操作</span></span><br><span class="line">        <span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"Enqueueing pending pause: "</span> + prev);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY,</span><br><span class="line">                        prev.userId, System.identityHashCode(prev),</span><br><span class="line">                        prev.shortComponentName);</span><br><span class="line">                mService.updateUsageStats(prev, <span class="keyword">false</span>);</span><br><span class="line">                prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">                        userLeaving, prev.configChangeFlags, dontWait);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>
<p>首先拿到 当前的前台Activity： ActivityRecord prev = mResumedActivity;</p>
<p>然后更改 ActivityStack  维护的相关记录。就是把 mResumedActivity（前台Activity）设置为null。然后把之前的那个前台Activity(A)赋给mPausingActivity，因为它马上就要Pause了。</p>
<p>之后通过 prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,<br>                        userLeaving, prev.configChangeFlags, dontWait); </p>
<p>发起Binder 跨进程调用，让那个前台Activity进程(Launcher进程)去把 Launcher Activity Pause掉。</p>
<p>prev.app.thread 说的是 在 AMS 里面持有的 前台进程的 ApplicationThreadProxy。<br>调用 ApplicationThreadProxy的 schedulePauseActivity，最终进入 ApplicationThread.schedulePauseActivity</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[ActivityThread.java]</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationThread</span> <span class="keyword">extends</span> <span class="title">ApplicationThreadNative</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">schedulePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> seq = getLifecycleSeq();</span><br><span class="line">            sendMessage(</span><br><span class="line">                    finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY,</span><br><span class="line">                    token,</span><br><span class="line">                    (userLeaving ? USER_LEAVING : <span class="number">0</span>) | (dontReport ? DONT_REPORT : <span class="number">0</span>),</span><br><span class="line">                    configChanges,</span><br><span class="line">                    seq);</span><br><span class="line">        &#125;    	</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>
<p>这里，使用 Handle 发送消息 到主线程。然后在主线程中 handleMessage<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityThread.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">	        ...</span><br><span class="line">                <span class="keyword">case</span> PAUSE_ACTIVITY: &#123;</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityPause"</span>);</span><br><span class="line">                    SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">                    handlePauseActivity((IBinder) args.arg1, <span class="keyword">false</span>,</span><br><span class="line">                            (args.argi1 &amp; USER_LEAVING) != <span class="number">0</span>, args.argi2,</span><br><span class="line">                            (args.argi1 &amp; DONT_REPORT) != <span class="number">0</span>, args.argi3);<span class="comment">//详见章节1.3.3</span></span><br><span class="line">                ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">	        ...</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>进入 ActivityThread.handlePauseActivity<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[ActivityThread.java]</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport, <span class="keyword">int</span> seq)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取需要</span></span><br><span class="line">        ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (userLeaving) &#123;</span><br><span class="line">                performUserLeavingActivity(r);</span><br><span class="line">            &#125;</span><br><span class="line">            r.activity.mConfigChangeFlags |= configChanges;</span><br><span class="line">            <span class="comment">//执行Activity的onPause操作</span></span><br><span class="line">            performPauseActivity(token, finished, r.isPreHoneycomb(), <span class="string">"handlePauseActivity"</span>);</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//通知AMS已经Pause成功了</span></span><br><span class="line">            ActivityManagerNative.getDefault().activityPaused(token);</span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>先 ActivityThread.performPauseActivity-&gt;进入另一个重载方法-&gt;ActivityThread.performPauseActivityIfNeeded-&gt;mInstrumentation.callActivityOnPause(r.activity);-&gt;activity.performPause();</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    onPause();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>最终执行了Activity的 onPause。</p>
<p>之后，回到ActivityThread.handlePauseActivity，</p>
<pre><code>//通知AMS已经Pause成功了
 ActivityManagerNative.getDefault().activityPaused(token);
</code></pre><p>这个 ActivityManagerNative.getDefault() 又是拿到 ActivityManagerProxy，Binder调用，告诉 AMS onPause 执行好了！最后会进入ActivityManagerService的activityPaused方法执行</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityManagerService.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityPaused</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        ActivityStack stack = ActivityRecord.getStackLocked(token);</span><br><span class="line">        <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">            stack.activityPausedLocked(token, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Binder.restoreCallingIdentity(origId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>ActivityStack.activityPausedLocked-&gt;ActivityStack.activityPausedLocked-&gt;ActivityStack.completePauseLocked</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!mService.isSleepingOrShuttingDownLocked()) &#123;<span class="comment">//会进入此分支</span></span><br><span class="line">                <span class="comment">//此时的prev为前台显示已经pause的Activity</span></span><br><span class="line">                mStackSupervisor.resumeFocusedStackTopActivityLocked(topStack, prev, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></div>
<p>最终进入：ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</p>
<p>进入ActivityStack.resumeTopActivityInnerLocked<br>此时的传入的prev就是我们已经pause的Activity的了。</p>
<p>这一次，由于所有resumedActivity都已经paused了，所以返回的结果pausing为false，所以可以继续进行目标activity的resume工作。<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;<span class="comment">//如果目的端进程已经创建,即要启动的目标Activity所属进程已经存在</span></span><br><span class="line">...</span><br><span class="line">         next.state = ActivityState.RESUMED;</span><br><span class="line">         mResumedActivity = next;</span><br><span class="line">         next.task.touchActiveTime();</span><br><span class="line">         mRecentTasks.addLocked(next.task);</span><br><span class="line">         mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">         updateLRUListLocked(next);</span><br><span class="line">         mService.updateOomAdjLocked();</span><br><span class="line">...</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">	...</span><br><span class="line">             next.sleeping = <span class="keyword">false</span>;</span><br><span class="line">             mService.showUnsupportedZoomDialogIfNeededLocked(next);</span><br><span class="line">             mService.showAskCompatModeDialogLocked(next);</span><br><span class="line">             next.app.pendingUiClean = <span class="keyword">true</span>;</span><br><span class="line">             next.app.forceProcessStateUpTo(mService.mTopProcessState);</span><br><span class="line">             next.clearOptionsLocked();</span><br><span class="line">	<span class="comment">//执行目的端Activity的scheduleResumeActivity操作</span></span><br><span class="line">             next.app.thread.scheduleResumeActivity(next.appToken, next.app.repProcState,</span><br><span class="line">                     mService.isNextTransitionForward(), resumeAnimOptions);</span><br><span class="line">	...</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	...</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             completeResumeLocked(next);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	<span class="comment">//处理异常</span></span><br><span class="line">             requestFinishActivityLocked(next.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                     <span class="string">"resume-exception"</span>, <span class="keyword">true</span>);</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;<span class="comment">//当目标Activity所属进程没有启动的时候，则会创建进程</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</span><br><span class="line">             next.hasBeenLaunched = <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW) &#123;</span><br><span class="line">                 next.showStartingWindow(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line"><span class="comment">//创建目标Activity进程</span></span><br><span class="line">         mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);	</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></div></p>
<ul>
<li><p>如果要启动的目标Activity所属进程已经创建，则直接通过ApplicationThreadProxy调用目标进程的ActivityThread执行相关的Activity的onCreate等相关生命周期</p>
</li>
<li><p>如果目标Activity所属进程没有创建，则通过startSpecificActivityLocked方法创建目标进程，经过层层调用最后会调用到AMS.attachApplicationLocked, 然后再执行resumeTopActivityInnerLocked继续resume操作。</p>
</li>
</ul>
<p>Pause前台显示Activity，Resume目标Activity小结<br>在上述过程中我们会进行两次resumeTopActivityInnerLocked方法：</p>
<ul>
<li><p>第一次是将所有resumedActivity进行pause，此时流程不会继续往下进行而是待前台显示的Activity真正执行pause后，然后回调AMS继续第二执行resumeTopActivityInnerLocked相关操作</p>
</li>
<li><p>由于此时所有处于Resume状态的Activity已经都被Pause了，所以继续往下执行，此时会判断目标Activity所属进程是否创建，如果创建则直接执行目标Activity的生命周期，如果没有创建则会创建目标Activity所属进程，进而再执行下一步操作</p>
</li>
</ul>
<p>我们假设目标进程没有创建，进入：</p>
<p>mStackSupervisor.startSpecificActivityLocked(next, true, true);    </p>
<p>进入调用<br>//调用AMS开启startProcess处理流程<br>        mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,<br>                “activity”, r.intent.getComponent(), false, false, true);//详见章节2.2</p>
<p>后面，就要为即将创建的进程在AMS中创建ProcessRecord信息记录，然调用Process.start去请求Zygote进程创建新的APP进程</p>
<p>Process.start(entryPoint,<br>                    app.processName, uid, uid, gids, debugFlags, mountExternal,<br>                    app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,<br>                    app.info.dataDir, entryPointArgs)</p>
<p>start后面就清楚了，使用Socket 同 Zygote 进程进行通信，Zygote进程创建新进程完成后，返回给 AMS。</p>
<p>新进程创建好，先打开Binder驱动，开启Binder线程池，然后会执行ActivityThread.main方法</p>
<p>从此，进入新开启的APP进程。</p>
<p>我们知道当Zygote创建完一个应用进程之后，得到的仅仅是一个可以运行的载体，对于应用开发者来说这还远远不够，Android的四大组件还没有侵入到这个新创的进程之中。对于Android应用开发者来说，基本淡化了进程相关的概念，所以当zygote进程创建目标Activity进程之，还需要创建一个运行环境，就是Context，然后创建Application，然后再装载Provider等组件信息，经过如上步骤操作之后才是应用开发者所熟悉的Android应用。</p>
<p>ActivityThread 的 main</p>
<ul>
<li><p>ActivityThread对象构建后，会调用自身的attach()函数，发起一个绑定操作，向system_server发起一个绑定操作，告诉AMS进程应启动完毕，可以进行其他事情了</p>
</li>
<li><p>初始化应用进程的主线程的Looper，并开启loop消息循环</p>
</li>
</ul>
<p>在  attach 中<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取AMS服务端的远程代理对象AMP</span></span><br><span class="line">            <span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            	<span class="comment">//通过Binder远程调用AMS的attachApplication方法</span></span><br><span class="line">                mgr.attachApplication(mAppThread);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>注意这里传递的mAppThread是一个匿名Binder实例（ApplicationThread对象），因此可以作为跨进程传递的参数。这里的mAppThread对象存在于应用进程，但会被传递到系统进程，在系统进程看来，此时的mAppThread就是操作应用进程的一个通信工具。后续，系统进程system_server如果想要向应用进程发起跨进程调用，也都需要通过mAppThread这个对象的远端代理ApplicationThreadProxy来完成相关的调度。</p>
<p>下面进入到 ActivityManagerService 的 attachApplication 方法，<br>//[ActivityManagerService.java]<br>    public final void attachApplication(IApplicationThread thread) {<br>        synchronized (this) {<br>            //获取调用进程端pid<br>            int callingPid = Binder.getCallingPid();<br>            final long origId = Binder.clearCallingIdentity();<br>            //attachApplicationLocked进行进一步处理<br>            attachApplicationLocked(thread, callingPid);<br>            Binder.restoreCallingIdentity(origId);<br>        }<br>    }</p>
<p>注意的是此时的参数类型IApplicationThread已经变成了匿名Binder的代理端了ATP了。<br>    进而调用：ActivityManagerService.attachApplicationLocked.</p>
<blockquote>
<p>   为啥目标Activity进程需要重新注册(attach)到system_server进程吗，上面的验证安全性是一个方面，另外一个方面就是通过注册(attach)的Binder远程调用传递匿名Binde类IApplicationThread给AMS，然后AMS就可以通过上述的匿名Binder继续对目标Activity进程的相关组件进行调度。</p>
</blockquote>
<p>在 attachApplicationLocked 里，主要工作：</p>
<ol>
<li>获取Activity目标进程在启动阶段由AMS向zygote进程发起请求时创建的ProcessRecord数据结构。</li>
<li>激活ProcessRecord对象。所谓“激活”，就是将ProcessRecord绑定到了一个具体的应用进程，绑定的标识就是将应用进程的ApplicationThread对象赋值给ProcessRecord.thread变量，注意此处的ApplicationThread是Binder的代理端，其实体端是在目标Activity进程端。</li>
<li>在进行一些调试与性能相关的变量设置之后，通过IApplicationThread.bindApplication()向目标Activity进程发起跨进程Binder调用，这样一来，诸如进程名、ApplicationInfo等等相关信息就传递给应用进程了。</li>
</ol>
<p>下来，ApplicationThread.bindApplication(…) （注意：ApplicationThread 是  ActivityThread.java中）</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将AMS传递过来的参数封装到AppBindData 数据结构中</span></span><br><span class="line">           AppBindData data = <span class="keyword">new</span> AppBindData();</span><br><span class="line">           data.processName = processName;</span><br><span class="line">		...</span><br><span class="line">           sendMessage(H.BIND_APPLICATION, data); <span class="comment">//通过Handle 发消息</span></span><br></pre></td></tr></table></figure></div>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">boolean</span> async)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(</span><br><span class="line">        TAG, <span class="string">"SCHEDULE "</span> + what + <span class="string">" "</span> + mH.codeToString(what)</span><br><span class="line">        + <span class="string">": "</span> + arg1 + <span class="string">" / "</span> + obj);</span><br><span class="line">    Message msg = Message.obtain();</span><br><span class="line">    msg.what = what;</span><br><span class="line">    msg.obj = obj;</span><br><span class="line">    msg.arg1 = arg1;</span><br><span class="line">    msg.arg2 = arg2;</span><br><span class="line">    <span class="keyword">if</span> (async) &#123;</span><br><span class="line">        msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mH.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>发消息之后，就到了handleMessage中<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[ActivityThread.java]</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">	        ...</span><br><span class="line">                <span class="keyword">case</span> BIND_APPLICATION:</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"bindApplication"</span>);</span><br><span class="line">                    AppBindData data = (AppBindData)msg.obj;</span><br><span class="line">                    handleBindApplication(data);</span><br><span class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">	        ...</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>然后在 ActivityThread.handleBindApplication中做如下工作：</p>
<ol>
<li>给当前进程（新创建的APP进程）设置进程名之类的</li>
<li>创建LoadedApk对象</li>
<li>创建ContextImpl对象</li>
<li>创建Instrumentation</li>
<li>创建Application对象,通过LoadedApk.makeApplication()函数，就能创建一个Application对象。保证一个LoadedApk对象只创建一个对应的Application对象实例，</li>
<li>安装providers，看来providers的安装都前于其它三大组件啊</li>
<li>调用Application.onCreate()方法</li>
</ol>
<p>创建 Application，是 Instrumentation.newApplication(…)通过反射，<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[Instrumentation.java]</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(ClassLoader cl, String className, Context context)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span></span><br><span class="line"><span class="function">            ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> newApplication(cl.loadClass(className), context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(Class&lt;?&gt; clazz, Context context)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span></span><br><span class="line"><span class="function">            ClassNotFoundException </span>&#123;</span><br><span class="line">        Application app = (Application)clazz.newInstance();</span><br><span class="line">        app.attach(context);<span class="comment">//执行attach操作</span></span><br><span class="line">        <span class="keyword">return</span> app;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>创建好后，执行Application的 attach<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context); <span class="comment">//Application的mBase</span></span><br><span class="line">    mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>其实就是调用Application 的额 attachBaseContext。</p>
<p>然后回调 LoadApk.makeApplication中，又调用了instrumentation.callApplicationOnCreate(app);</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Instrumentation.java</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callApplicationOnCreate</span><span class="params">(Application app)</span> </span>&#123;</span><br><span class="line">        app.onCreate();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>
<p>这样就调用到了 Application的 onCreate。</p>
<p>继续：</p>
<p>在 ActivityManagerService 的 attachApplicationLocked里，<br>调用IApplicationThread.bindApplication之后，执行 <code>mStackSupervisor.attachApplicationLocked(app)</code></p>
<p>进入：realStartActivityLocked</p>
<p>执行：app.thread.scheduleLaunchActivity<br>通过app.thread.scheduleLaunchActivity实际上调用的就是目标Activity进程中ActivityThread的内部类ApplicationThread的scheduleLaunchActivity方法中去了，进而调度启动目标Activity</p>
<p>此时 ApplicationThread 中的 scheduleLaunchActivity()方法在ApplicationThread的Binder线程中执行，在该方法中将AMS传递过来的参数填充ActivityClientRecord数据结构，然后通过Handle发送Message，然后在ActivityThread的主线程中执行处理，而处理上述逻辑的即是handleLaunchActivity()方法！<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">    <span class="comment">// //加载目标Activity，并最终回调目标Activity的onCreate和onStart</span></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">       ...</span><br><span class="line">       <span class="comment">// //最终回调目标Activity的onResume.</span></span><br><span class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</span><br><span class="line">            ...</span><br><span class="line">            performPauseActivityIfNeeded(r, reason);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>在 ActivityThread 的  handleLaunchActivity中：<code>Activity a = performLaunchActivity(r, customIntent);</code><br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[ActivityThread.java]</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        ComponentName component = r.intent.getComponent();</span><br><span class="line">        <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">            component = r.intent.resolveActivity(</span><br><span class="line">                mInitialApplication.getPackageManager());</span><br><span class="line">            r.intent.setComponent(component);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                    r.activityInfo.targetActivity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Activity activity = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">/*</span></span><br><span class="line"><span class="comment">        		通过反射加载目标Activity</span></span><br><span class="line"><span class="comment">        	*/</span></span><br><span class="line">            java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            <span class="comment">/*****************************************************/</span></span><br><span class="line">            	<span class="comment">//这里为了演示方便，直接把源码展开</span></span><br><span class="line">            	<span class="comment">//[Instrumentation.java]</span></span><br><span class="line">			    <span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className,</span></span></span><br><span class="line"><span class="function"><span class="params">			            Intent intent)</span></span></span><br><span class="line"><span class="function">			            <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">			            ClassNotFoundException </span>&#123;</span><br><span class="line">			        <span class="keyword">return</span> (Activity)cl.loadClass(className).newInstance();</span><br><span class="line">			    &#125;            	</span><br><span class="line">            <span class="comment">/*****************************************************/</span>      </span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">/*</span></span><br><span class="line"><span class="comment">        		创建目标Actiivty应用进程Application，目标Application在前面博客中已经有被创建了，而且</span></span><br><span class="line"><span class="comment">        		应用进程的Application是唯一的，所以会直接返回前面创建的Applcation</span></span><br><span class="line"><span class="comment">        	*/</span></span><br><span class="line">            Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            	<span class="comment">//创建目标Activity对应的Context上下文</span></span><br><span class="line">                Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">//将上述创建的相关信息，attach到Activity中为后续Activity显示运行做准备     </span></span><br><span class="line">                activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window);</span><br><span class="line"></span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">//开始执行目标Activity的onCreate()方法回调</span></span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                    activity.performStart();<span class="comment">//执行目标Activity的onStart()方法</span></span><br><span class="line">                    r.stopped = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">				...</span><br><span class="line">            &#125;</span><br><span class="line">            r.paused = <span class="keyword">true</span>;</span><br><span class="line">			<span class="comment">//将目标Activity相关信息，保存到mActivities中</span></span><br><span class="line">            mActivities.put(r.token, r);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;        </span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>首先拿到 ComponentName，然后拿到 ClassCloader，使用 mInstrumentation  newActivity。</p>
<p>然后这块使用反射，创建了一个Activity出来<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Activity)cl.loadClass(className).newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>Activity创建好了之后，给它一个Context<br>Context appContext = createBaseContextForActivity(r, activity);</p>
<p>然后调用<code>mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</code><br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle,</span></span></span><br><span class="line"><span class="function"><span class="params">        PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">    prePerformCreate(activity);</span><br><span class="line">    activity.performCreate(icicle);</span><br><span class="line">    postPerformCreate(activity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></p>
<p>调用Activity的 activity.performCreate(icicle);</p>
<p>进而调用到Activity的 onCreate()方法<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">       restoreHasCurrentPermissionRequest(icicle);</span><br><span class="line">       onCreate(icicle);</span><br><span class="line">       mActivityTransitionState.readState(icicle);</span><br><span class="line">       performCreateCommon();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>之后，回到ActivityThread的 performLaunchActivity 方法中，又调用<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                   activity.performStart();<span class="comment">//执行目标Activity的onStart()方法</span></span><br><span class="line">                   r.stopped = <span class="keyword">false</span>;</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>这就执行了Activity的 onStart方法。</p>
<p>完了之后，回到： <code>ActivityThread.handleLaunchActivity(…)</code>，继续执行 <code>ActivityThread.handleResumeActivity</code></p>
<p>进而：<br><code>r = performResumeActivity(token, clearHide, reason);</code></p>
<p>里面： <code>r.activity.performResume();</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先判断是否要Restart，如果有必须，要执行onRestart方法</span></span><br><span class="line">        performRestart();</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line">        mInstrumentation.callActivityOnResume(<span class="keyword">this</span>);</span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">        onPostResume();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>
<p>performRestart里面会根据条件，执行 <code>mInstrumentation.callActivityOnRestart(this);</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Instrumentation.java</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnRestart</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        activity.onRestart();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>
<p>然后就执行了Activity的 onRestart()方法.</p>
<p>mInstrumentation.callActivityOnResume(this);</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnResume</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        activity.mResumed = <span class="keyword">true</span>;</span><br><span class="line">        activity.onResume(); <span class="comment">// 执行Activity的onResume方法</span></span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>
<p>至此我们的整个的Actiivty启动流程到此就结束了！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Fan shanhong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2021/03/08/Android/系统/Activity启动/">http://yoursite.com/2021/03/08/Android/系统/Activity启动/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2021/03/14/Android/系统/binder/1.Binder系统核心/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>Binder系统核心</span></div></a></div><div class="next-post pull_right"><a href="/2021/03/08/Android/系统/window/window的创建/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>Window的创建</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2018/10/08/Android/系统/启动/冷启动/" title="冷启动热启动"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-08</div><div class="relatedPosts_title">冷启动热启动</div></div></a></div><div class="relatedPosts_item"><a href="/2018/10/06/Android/其他/APK安装和卸载源码分析/" title="APK安装和卸载源码分析"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-06</div><div class="relatedPosts_title">APK安装和卸载源码分析</div></div></a></div><div class="relatedPosts_item"><a href="/2018/11/08/Android/其他/SharedPreference分析/" title="SharedPreference分析"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-11-08</div><div class="relatedPosts_title">SharedPreference分析</div></div></a></div><div class="relatedPosts_item"><a href="/2018/10/08/Android/其他/getExternalCacheDir目录下的东东, 在APK卸载的时候是否会被删除/" title="getExternalCacheDir目录下的东东, 在APK卸载的时候是否会被删除"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-08</div><div class="relatedPosts_title">getExternalCacheDir目录下的东东, 在APK卸载的时候是否会被删除</div></div></a></div><div class="relatedPosts_item"><a href="/2018/10/02/Android/其他/查看处理器架构命令/" title="查看处理器架构命令"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-10-02</div><div class="relatedPosts_title">查看处理器架构命令</div></div></a></div><div class="relatedPosts_item"><a href="/2018/12/08/Android/其他/versionName和versionCode/" title="versionName和versionCode"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-12-08</div><div class="relatedPosts_title">versionName和versionCode</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By Fan shanhong</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async></script></body></html>